<html><head><link rel="import" href="../polymer/polymer-element.html"></head><body><dom-module id="dolphin-controller"><script>const STATUS_READY="READY",STATUS_NOT_READY="NOT-READY";class DolphinController extends Polymer.Element{static get is(){return"dolphin-controller"}static get properties(){return{clientContext:{type:Object,value:()=>window.clientContext},status:{type:String,value:STATUS_NOT_READY},name:String,model:{type:Object,notify:!0,readOnly:!1},noCreate:{type:Boolean,value:!1},noDestroy:{type:Boolean,value:!1}}}static get observers(){return["_onClientContextChanged(clientContext)","_onModelChanged(model.*)"]}constructor(){super(),this._initBeanRegistry()}connectedCallback(){super.connectedCallback();isTruthy(this.noCreate)||this.create()}disconnectedCallback(){super.disconnectedCallback();isTruthy(this.noDestroy)||this.destroy()}create(){isNil(this.clientContext)||isNil(this.name)||(this._onControllerInitializing(),this.clientContext.createController(this.name).then((a)=>{this._onControllerCreated(a),isNil(a.onDestroyed)||a.onDestroyed(()=>{this._onControllerDestroyed(a)})}))}destroy(){isNil(this._controller)||this._controller.destroy()}invoke(a,b){return this._controller.invoke(a,b)}_onControllerInitializing(){this._controller=null,this.status=STATUS_NOT_READY}_onControllerCreated(a){this._controller=a,this.status=STATUS_READY,this._onRootBeanChanged(this._controller.model)}_onControllerDestroyed(){this._onRootBeanChanged(this._controller.model),this._controller=null,this.status=STATUS_NOT_READY}_onClientContextChanged(){isNil(this.clientContext)||(this._beanManager=this.clientContext.beanManager,this._beanManager.onBeanUpdate(this._onBeanPropertyChanged.bind(this)),this._beanManager.onArrayUpdate(this._onBeanPropertySpliced.bind(this)))}_notifyBeanPropertyChanged(a,b,c){return this.status===STATUS_READY?this._beanManager.notifyBeanChange(a,b,c):void 0}_notifyBeanPropertySpliced(a,b,c,d,e){return this.status===STATUS_READY?this._beanManager.notifyArrayChange(a,b,c,e,d):void 0}_onRootBeanChanged(a){this.set("model",a),isObject(a)&&this._bindBean(a,"model")}_onBeanPropertyChanged(a,b,c,d){if(!isEqual(c,d)){const d=this._queryPropertyPaths(a);if(0<d.size){const a=Array.from(d)[0],e=this._buildPropertyPath(a,b);this.set(e,c)}else a[b]=c}}_onBeanPropertySpliced(a,b,c,d,e){const f=a[b],g=f.slice(c,c+d);if(!isArrayEqual(e,g)){const f=this._queryPropertyPaths(a);if(0<f.size){const a=Array.from(f)[0],g=this._buildPropertyPath(a,b);this.splice(g,c,d,...e)}else a[b].splice(c,d,...e)}}_onModelChanged(a){if(this.status!==STATUS_READY)return;const b=(a,b,c)=>{const d=this._slicePropertyPath(b,0,-1),e=this._slicePropertyPath(b,-1),f=Polymer.Path.get(a,d),g=Polymer.Path.get(a,b);for(const d of c){const{items:a,startIndex:c,removedItems:g,addedCount:h}=d;this._notifyBeanPropertySpliced(f,e,c,g,h),this._updateArrayBindings(b,a,c,g,h)}},c=(a)=>{const{object:b,index:c,removed:d,addedCount:e}=a;return{items:b,startIndex:c,removedItems:d,addedCount:e}},d=a.value,e={model:a.base},f=a.path;if(((a)=>{const{value:b,path:c,base:d}=a;return b&&!isNil(b.indexSplices)&&c.endsWith(".splices")})(a)){const a=this._slicePropertyPath(f,0,-1),g=d.indexSplices.map((a)=>c(a));b(e,a,g)}else((a,b,c)=>{const d=this._slicePropertyPath(b,0,-1),e=this._slicePropertyPath(b,-1),f=Polymer.Path.get(a,d),g=Polymer.Path.get(a,b);if(!isArray(g)&&!("length"===e&&isArray(f))&&!isNil(f)){const a=this._notifyBeanPropertyChanged(f,e,c);this._updateBeanBinding(b,c,a)}})(e,f,d)}_updateBeanBinding(a,b,c){isNil(c)||this._unbindBean(c,a),isNil(b)||this._bindBean(b,a)}_updateArrayBindings(a,b,c,d,e){for(let f=0;f<d.length;f++){const b=d[f],e=this._buildPropertyPath(a,c+f);this._unbindBean(b,e)}for(let f=c+e;f<b.length;f++){const c=b[f],g=this._buildPropertyPath(a,f-e+d.length);this._unbindBean(c,g)}for(let f=c;f<b.length;f++){const c=b[f],d=this._buildPropertyPath(a,f);this._bindBean(c,d)}}_bindBean(a,b){isNil(a)||!isObject(a)||(this._registerPropertyPath(a,b),forEach(a,(a,c)=>{const d=this._buildPropertyPath(b,c);this._bindBean(a,d)}))}_unbindBean(a,b){isNil(a)||!isObject(a)||(this._unregisterPropertyPath(a,b),forEach(a,(a,c)=>{const d=this._buildPropertyPath(b,c);this._unbindBean(a,d)}))}_initBeanRegistry(){this._beanRegistry=new Map}_queryPropertyPaths(a){return this._beanRegistry.get(a)||new Set}_registerPropertyPath(a,b){const c=this._queryPropertyPaths(a);0===c.size&&this._beanRegistry.set(a,c),c.add(b)}_unregisterPropertyPath(a,b){const c=this._queryPropertyPaths(a);c.delete(b),0===c.size&&this._beanRegistry.delete(a)}_buildPropertyPath(...a){return Polymer.Path.normalize(a.filter((a)=>!isEmptyString(a)))}_slicePropertyPath(a,b,c=void 0){const d=Polymer.Path.split(a);return Polymer.Path.normalize(d.slice(b,c))}}window.customElements.define(DolphinController.is,DolphinController);function pretty(a,b=2){return JSON.stringify(a,function(a,b){if(b&&b[Symbol.iterator]&&!isArray(b)){const a=Array.from(b);if(a&&!isArrayEqual(a,b))return a}return b},b)}function pretty1(a){const b=pretty(a,1);return b.split("\n").map((a)=>a.trim()).join(" ")}function pretty0(a){return pretty(a,0)}function isObject(a){return"object"===typeof a}function isArray(a){return Array.isArray(a)}function isNil(a){return null===a||a===void 0}function isTruthy(a){return!!a}function isEmptyString(a){return""===a}function isEqual(c,a){return c===a}function isArrayEqual(c,a){if(c===a||isNil(c)&&isNil(a))return!0;if(isNil(c)!==isNil(a))return!1;if(c.length!==a.length)return!1;for(let b=0;b<c.length;b++)if(c[b]!==a[b])return!1;return!0}function forEach(a,b){Object.keys(a).forEach((c)=>b(a[c],c,a))}</script></dom-module></body></html>